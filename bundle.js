(()=>{"use strict";(()=>{const e=document.querySelector(".map__pins"),t={x:{min:e.getBoundingClientRect().left,max:e.getBoundingClientRect().right},y:{min:130,max:630}};window.consts={PinLocation:t,PinMain:{x:65,y:87},PinMainDefault:{x:570,y:375}}})(),window.utils={getRandom:(e,t)=>Math.floor(e+Math.random()*(t+1-e)),getRandomFromArray:e=>e[window.utils.getRandom(0,e.length-1)],shuffleArray:e=>{const t=[...e];for(let e=t.length-1;e>0;e--){const o=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[o],t[o]=n}return t},isEscEvt:(e,t)=>{"Escape"===e.key&&t()},isEnterEvt:(e,t)=>{"Enter"===e.key&&t()},addressToString:(e,t)=>`${e}, ${t}`,getCoords:e=>{const t=e.getBoundingClientRect();return{x:t.left+pageXOffset,y:t.top+pageYOffset}}},(()=>{const e=document.querySelector(".map__pins .map__pin--main"),t=document.querySelector(".ad-form"),o=document.querySelector(".map__filters"),n=e=>{0===e.button&&i()},r=e=>{window.utils.isEnterEvt(e,i),delete e.keyCode},i=()=>{window.map.show(),window.form.enable(),window.backend.download(window.map.onLoad,window.backend.onDownloadError),window.form.fillAddress(e,window.consts.PinMain.x,window.consts.PinMain.y),e.removeEventListener("keydown",r),e.removeEventListener("mousedown",n)};e.addEventListener("mousedown",n),e.addEventListener("keydown",r),window.init={deactivate:()=>{window.pin.remove(),window.card.remove(),window.map.hide(),window.form.disable(),window.filters.disable(),e.style.left=window.consts.PinMainDefault.x+"px",e.style.top=window.consts.PinMainDefault.y+"px",window.form.fillAddress(e,window.consts.PinMain.x,window.consts.PinMain.x),t.reset(),o.reset(),window.previews.clear(),e.addEventListener("mousedown",n),e.addEventListener("keydown",r)}}})(),(()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),o=t.querySelector(".error__button"),n=(e,t,o,n,r)=>{const i=new XMLHttpRequest;i.responseType="json",i.open(e,t),i.addEventListener("load",(()=>{200===i.status?(o(i.response),window.filters.enable()):n("Ошибка загрузки данных")})),i.addEventListener("error",(()=>{n("Oшибка соединения")})),i.addEventListener("timeout",(()=>{n("Запрос не успел выполниться за"+i.timeout+"mc")})),i.send(r)},r=(e,t)=>{document.querySelector("main").insertAdjacentElement("afterbegin",e);const n=()=>{document.querySelector(t).remove(),window.removeEventListener("click",n),document.removeEventListener("keydown",r),o&&o.removeEventListener("click",n)},r=e=>{window.utils.isEscEvt(e,n)};document.addEventListener("keydown",r),window.addEventListener("click",n),o&&o.addEventListener("click",n)};window.backend={download:(e,t)=>{n("GET","https://21.javascript.pages.academy/keksobooking/data",e,t)},upload:(e,t,o)=>{n("POST","https://21.javascript.pages.academy/keksobooking",o,t,e)},onDownloadError:e=>{const t=document.body.querySelector("div.divError");t&&t.remove();const o=document.createElement("div");o.className="div-error",o.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",o.style.position="absolute",o.style.left="10%",o.style.right="20%",o.style.fontSize="20px",o.style.opacity="0.5",o.textContent=e,document.body.insertAdjacentElement("afterbegin",o)},onFormSuccess:()=>{r(e,".success")},onFormError:()=>{r(t,".error")}}})(),window.pinsData={store:[],saveToStore:e=>{window.pinsData.store=e},getByNum:e=>window.pinsData.store[e]},(()=>{const e=document.querySelector(".map__pin--main");e.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY},n=!1;const r=t=>{t.preventDefault(),n=!0;let r=o.x-t.clientX,i=o.y-t.clientY;o={x:t.clientX,y:t.clientY},e.style.top=e.offsetTop-i+"px",e.style.left=e.offsetLeft-r+"px";const s=document.querySelector(".map__pins").clientWidth,d=document.querySelector(".map__pins").offsetLeft;e.offsetTop-i<window.consts.PinLocation.y.min-window.consts.PinMain.y?e.style.top=window.consts.PinLocation.y.min-window.consts.PinMain.y+"px":e.offsetTop-i>window.consts.PinLocation.y.max-window.consts.PinMain.y?e.style.top=window.consts.PinLocation.y.max-window.consts.PinMain.y+"px":e.offsetLeft-r<d-window.consts.PinMain.x/2?e.style.left=d-window.consts.PinMain.x/2+"px":e.offsetLeft-r>s-window.consts.PinMain.x/2&&(e.style.left=s-window.consts.PinMain.x/2+"px")},i=t=>{if(t.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",i),n){const t=o=>{o.preventDefault(),e.removeEventListener("click",t)};e.addEventListener("click",t)}window.form.fillAddress(e,window.consts.PinMain.x,window.consts.PinMain.y)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",i)}))})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters-container"),o=document.querySelector(".map__pins"),n=n=>{window.pin.remove(),window.pin.render(n);const r=o.querySelectorAll("button[data-pin-id]");for(let o of r){const r=r=>{window.card.remove(),window.pin.removeActive(),o.classList.add("map__pin--active");const i=r.target.getAttribute("data-pin-id");e.insertBefore(window.card.generate(n[i]),t)};o.addEventListener("click",r)}};window.map={show:()=>{e.classList.remove("map--faded")},hide:()=>{e.classList.add("map--faded")},onLoad:e=>{window.pinsData.saveToStore(e),n(e)},updatePins:n}})(),(()=>{const e=document.createDocumentFragment(),t=document.querySelector(".map__pins"),o=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0);window.pin={generate:(e,t)=>{const n=o.cloneNode(!0),r=n.querySelector("img");return r.setAttribute("data-pin-id",t),r.src=e.author.avatar,r.alt=e.offer.title,n.setAttribute("data-pin-id",t),n.style.left=e.location.x-25+"px",n.style.top=e.location.y-70+"px",n},render:o=>{for(let t=0;t<o.length&&t<5;t++)e.append(window.pin.generate(o[t],t));t.append(e)},remove:()=>{const e=t.querySelectorAll("button[data-pin-id]");for(let t of e)t.remove()},removeActive:()=>{const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__upload input[type=file]"),r=document.querySelector(".ad-form__photo"),i=(t,o,n)=>{if(e.some((e=>t.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{n.src=e.result})),e.readAsDataURL(o)}};t.addEventListener("change",(()=>{const e=t.files[0],n=e.name.toLowerCase();i(n,e,o)})),n.addEventListener("change",(()=>{const e=n.files[0],t=e.name.toLowerCase();r.innerHTML="";const o=document.createElement("img");o.setAttribute("src",""),o.setAttribute("alt","фото жилья"),o.setAttribute("width","100%"),o.setAttribute("height","100%"),r.appendChild(o),i(t,e,o)})),window.previews={clear:()=>{r.innerHTML="",o.setAttribute("src","img/muffin-grey.svg")}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelectorAll("fieldset"),o=e.querySelector('button[type="reset"]'),n=e.querySelectorAll("input"),r=document.querySelector("#address"),i=e.querySelector("#room_number"),s=e.querySelector("#capacity"),d=e.querySelector("#price"),a=e.querySelector("#type"),c=e.querySelector("#timeout"),l=e.querySelector("#timein"),u=e.querySelector("#title");i.addEventListener("change",((e,t)=>{const o={1:[1],2:[1,2],3:[1,2,3],100:[0]};return()=>{const n=+e.value,r=t.options,i=o[n];for(let e=0;e<r.length;e++)-1!==i.indexOf(+r[e].value)?(r[e].disabled=!1,+r[e].value!==n&&1!==i.length||(r[e].selected=!0)):r[e].disabled=!0}})(i,s)),u.addEventListener("input",(()=>{const e=u.value.length;e<30?u.setCustomValidity("Минимальная длина - 30 символов. Осталось "+(30-e)):(u.setCustomValidity(""),u.style.outline="none"),u.reportValidity()})),d.addEventListener("input",(()=>{parseInt(d.value,10)<parseInt(d.min,10)?d.setCustomValidity(`Минимальная цена: ${d.min}Р.`):(d.setCustomValidity(""),d.style.outline="none"),d.reportValidity()})),e.addEventListener("change",(()=>{"bungalow"===a.value?(d.placeholder=0,d.min=0):"flat"===a.value?(d.placeholder=1e3,d.min=1e3):"house"===a.value?(d.placeholder=5e3,d.min=5e3):"palace"===a.value&&(d.placeholder=1e4,d.min=1e4),c.value=l.value})),e.addEventListener("submit",(t=>{t.preventDefault(),window.backend.upload(new FormData(e),window.backend.onFormError,(()=>{window.backend.onFormSuccess(),window.init.deactivate()}))})),e.querySelector('button[type="submit"]').addEventListener("click",(()=>{for(let e of n)!1===e.checkValidity()?e.style.outline="red solid 2px":e.style.outline="none"})),window.form={enable:()=>{e.classList.remove("ad-form--disabled");for(let e of s.options)e.disabled=!0;s.querySelector('[value="1"]').selected=!0,s.querySelector('[value="1"]').disabled=!1,a.querySelector('[value="house"]').selected=!0,t.forEach((e=>{e.disabled=!1})),o.addEventListener("click",(()=>{window.init.deactivate(),n.forEach((e=>{e.style.outline="none"}))}))},disable:()=>{e.classList.add("ad-form--disabled"),t.forEach((e=>{e.disabled=!0})),o.removeEventListener("click",(()=>{window.init.deactivate()}))},fillAddress:(e,t,o)=>{const{x:n,y:i}=window.utils.getCoords(e);r.setAttribute("value",window.utils.addressToString(Math.floor(n+t/2),Math.floor(i+o)))}}})(),(()=>{const e=document.createDocumentFragment(),t=document.querySelector("#card").content.querySelector(".popup").cloneNode(!0),o=t.querySelector("img"),n=t.querySelector(".popup__features"),r=n.querySelector(".popup__feature"),i=t.querySelector(".popup__close"),s=t.querySelector(".popup__photos"),d=s.querySelector(".popup__photo");s.removeChild(d);const a={flat:"квартира",house:"дом",bungalow:"бунгало",palace:"дворец"};window.card={generate:c=>{o.src=c.author.avatar,t.querySelector(".popup__title").textContent=c.offer.title,t.querySelector(".popup__text--address").textContent=c.offer.address,t.querySelector(".popup__text--price").textContent=c.offer.price+" ₽/ночь",t.querySelector(".popup__type").textContent=a[c.offer.type],t.querySelector(".popup__text--capacity").textContent=`${c.offer.rooms} комнаты для ${c.offer.guests} гостей`,t.querySelector(".popup__text--time").textContent=`Заезд после ${c.offer.checkin}, выезд до ${c.offer.checkout}`,t.querySelector(".popup__description").textContent=c.offer.description,(o=>{s.innerHTML="",s.remove(),o.offer.photos.length>0&&(t.appendChild(s),o.offer.photos.forEach((t=>{e.appendChild(d.cloneNode(!0)).src=t})),s.appendChild(e))})(c),(o=>{n.remove(),n.innerHTML="",o.offer.features.length>0&&(t.insertBefore(n,t.querySelector(".popup__description")),o.offer.features.forEach((t=>{let o=r.cloneNode(!0);o.className=o.className.replace("wifi",t),e.appendChild(o)})),n.appendChild(e))})(c);const l=()=>{window.removeCard()},u=e=>{window.utils.isEscEvt(e,window.removeCard)};return window.removeCard=()=>{t.remove(),window.pin.removeActive(),document.removeEventListener("keydown",u),i.removeEventListener("click",l)},i.addEventListener("click",l),document.addEventListener("keydown",u),t},remove:()=>{document.querySelector(".map__card.popup")&&window.removeCard()}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e.apply(null,[...o])}),500)}},(()=>{const e=document.querySelector(".map__filters"),t=e.querySelectorAll("select"),o=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),r=e.querySelector("#housing-type"),i=e.querySelector("#housing-price"),s=e.querySelector("#housing-features");e.addEventListener("change",window.debounce((()=>{window.card.remove();const e=window.pinsData.store.filter((e=>"any"===r.value?window.pinsData.store:e.offer.type===r.value)),t=e.filter((t=>"any"===i.value?e:"low"===i.value?t.offer.price<1e4:"middle"===i.value?t.offer.price>=1e4&&t.offer.price<=5e4:"high"===i.value&&t.offer.price>5e4)),d=t.filter((e=>"any"===o.value?t:e.offer.rooms===parseInt(o.value,10))),a=d.filter((e=>"any"===n.value?d:e.offer.guests===parseInt(n.value,10))).filter((e=>{const t=s.querySelectorAll('input[type="checkbox"]:checked');let o=[];for(let e of t)o.push(e.value);return o.every((t=>e.offer.features.includes(t)))}));window.map.updatePins(a)}))),window.filters={enable:()=>{for(let e of t)e.disabled=!1;e.querySelector("fieldset.map__features").disabled=!1,e.classList.remove("map__filters--disabled"),e.style.opacity=1},disable:()=>{for(let e of t)e.disabled=!0;e.querySelector("fieldset.map__features").disabled=!0,e.classList.add("map__filters--disabled"),e.style.opacity=0,e.reset()}}})(),(()=>{const e=document.querySelector(".map__pins").querySelector(".map__pin--main");window.init.deactivate(),window.form.fillAddress(e,window.consts.PinMain.x,window.consts.PinMain.x)})()})();